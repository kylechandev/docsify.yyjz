# 自动记账(Android)

Android v7.3 版本后，支持自动记账功能。

自动记账为会员功能，并提供15天免费试用时间。

## 前言

自动记账的识别是在本地离线进行的，所以随着第三方 app (例如支付宝等)的更新，他们的界面内容可能发生变化导致自动记账无法正确识别。如果遇到无法识别的场景，敬请与我们联系～ 我们将尽快完成适配并更新新版本。

> [联系我们](/doc/other/contact.md)

## 介绍

自动记账通过 Android 系统提供的「无障碍」能力实现。打开「无障碍」权限后，系统可以将 app 界面（可设置支持的 app）上显示的文本返回给一羽记账，一羽记账通过本地离线算法将这些文本归纳识别成一条账单，再通过「悬浮窗」权限自动弹出记账面板，可以在自动记账面板中继续编辑账单信息，然后再确认保存。

由于系统「无障碍」并不稳定，需要 app 做好保活措施，所以还需要「通知」权限，用于显示一个自动记账前台通知，防止 app 被系统杀死，导致「无障碍」权限被关闭。

## 权限与设置

通过前面的介绍，开启自动记账 需要授予部分权限，以及设置好 app 的保活措施。

### 权限

| 权限  | 说明                         |
| --- | -------------------------- |
| 无障碍 | 基础自动记账权限，用于识别界面            |
| 悬浮窗 | 用于识别界面并成功归纳成一条账单后，弹出自动记账面板 |
| 通知  | 用于保活 app，防止 无障碍 权限不稳定被系统关闭 |

* 当 app 被系统杀死后、app 版本升级后、手机重启后，系统无障碍权限都会被关闭，需要重新手动打开无障碍权限。

* 如果发现自动记账已打开，但仍无法正常使用，请尝试关闭再重新打开无障碍权限。

* 建议根据 app 内自动记账设置提示，设置好 app 保活措施。

## 自动记账

首次识别时，由于界面信息有限，账单部分信息（例如分类、账户）无法确定，需要手动选择一次，后续再次识别相同界面时，一羽记账就可以自动填充这部分账单信息了。

<font color=gray>(根据商户、店铺自动匹配识别)</font>

自动记账支持的识别场景：

* 扫码支付完成后

* 进入例如支付宝的账单明细界面（包括红包、转账等场景）

### 自动记账 App

一羽记账默认开启所有支持识别的自动记账 App（例如支付宝、微信、云闪付等）。

如果部分 App 无需识别，可以在一羽记账中关闭，只保留需要识别的 App，这样系统就不会再返回这些 App 的界面信息。

如果关闭了所有支持的自动记账 App，则相当于禁用了自动记账，系统不会返回任何 App 的界面信息。

## 快速体验

1. 开启自动记账，并确保以上权限与设置已设置完成。

2. 打开 支付宝app 或 微信app，进入账单界面，点进任意一个账单明细界面。

3. 此时会自动识别界面信息归纳出账单并自动弹出记账面板，同时会自动填充一些基本信息，例如账单日期、类型、金额等，可以手动调整后再确认保存账单。

如果以上步骤可以弹出自动记账面板，说明自动记账功能已配置完成。

## FAQ

### 隐私与安全

一羽自动记账账单识别在本地离线进行，在获得系统「无障碍」返回的界面信息后，只做识别，不额外保存任何界面信息和数据。

若自动记账识别失败，会在本地存储相关失败的日志信息，且仅存储在本地，可以在「自动记账 - 自动记账日志」看到。如果遇到无法识别的场景，敬请联系我们～ 将 无法识别的界面截图 或将 失败日志 发送给我们。

### 自动记账的支持场景

语言：简体中文

自动记账App：支付宝、微信、云闪付等等（更多可在 App 内查看）

识别场景：自动记账只识别特定 App 的特定界面，例如 支付完成界面，账单明细界面。

> 如果遇到无法识别的场景，请联系我们适配～
> 
> 自动记账依赖第三方 App（例如支付宝）的界面信息，若第三方 App 进行界面更新，自动记账也需要更新版本适配（因为是本地离线识别）。
> 
> 若第三方 App 在更新调整后导致「无障碍」不返回有效信息，可能导致自动记账失效。

### 无障碍权限

无障碍权限是 Android 一项敏感权限，也比较不稳定，当 app 被系统杀死、app 版本更新、系统重启后，都会导致无障碍权限被关闭，此时需要再手动开启。

如果出现「此服务出现故障」或者「此服务受到限制」等类似提示，请关闭并重新打开「无障碍」权限开关 或者 尝试重启手机。

确保是从官方 App Store 下载安装。

#### 无障碍无法开启「受限制的设置，出于安全考虑，此设置目前不可用」

这是由于「Android13/14」系统开始增加的限制。

表现形式是：在无障碍界面，无法开启无障碍权限 或 列表呈现灰色。

<img src="https://s21.ax1x.com/2024/07/27/pkqVseg.jpg" title="" alt="受限制的设置" width="392">

解决办法：

**先点击开启无障碍权限（如果列表呈现灰色，也点击它）**，系统会弹出类似「受限制的设置」的提示，因为有些系统必须先触发这个弹窗，然后设置中应用详情里才会出现相关「受限制的设置」的操作选项。

然后在系统应用设置中如下操作：

![受限制的设置通用](https://s21.ax1x.com/2024/07/27/pkqVhlV.png)

注：小米手机的操作位置可能有所不同：

![受限制的设置小米](https://s21.ax1x.com/2024/07/27/pkqVDOS.png)

### 支付完成界面无法显示自动记账面板

这是由于部分系统限制了在支付软件上层显示悬浮窗，所以导致自动记账面板无法弹出。

需要关闭系统自带的 支付保护 功能。

可以参考下面教程中的关闭方法，也可以直接在系统设置中搜索有关「支付保险箱」「支付安全」等类似关键词直达。

[oppo手机怎么关闭支付保护-百度经验](https://jingyan.baidu.com/article/642c9d34ea5eda254b46f70a.html)

[vivo手机支付保险箱怎么设置-百度经验](https://jingyan.baidu.com/article/2d5afd69cad5b4c4a3e28ed1.html)

[小米支付保险箱怎么打开-百度经验](https://jingyan.baidu.com/article/08b6a591d3779955a80922bb.html)

[华为支付保护中心](https://consumer.huawei.com/cn/support/content/zh-cn15768863/)

[荣耀支付保护中心](https://www.honor.com/cn/support/content/zh-cn15815300/)

### 无法弹出输入法 或 输入法一闪而过

需要关闭系统自带的 隐私输入模式。

以小米为例：系统设置 -> 隐私保护 -> 隐私输入模式 ->  关闭。

<font color=gray>目前暂未发现其他机型有相关设置，如果无法使用输入法，可以尝试参考小米系统的操作步骤。</font>

### 发红包无法立即显示自动记账面板

因为 支付宝app 和 微信app 在包红包后，并没有支付完成界面，所以自动记账无法识别，需要点开红包后，来识别红包明细界面。

### [EXTRA] For 手机发烧友

如果确保已经完成以上所有设置，但仍然无法弹出自动记账，或只有部分App可以弹出自动记账，部分App又不可以弹出自动记账，请做如下检查：

1. 前往一羽记账App自动记账设置界面，检查「自动记账App」设置中是否开启了对应App的自动记账选项。

2. 检查已安装的模块，是否有模块可以阻止App检测无障碍，如果有，请关闭它。

## 更多

> [开放 URL-Scheme](doc/func/url-scheme.md)

可以通过开放 URL-Scheme，搭配第三方自动记账app，来实现自己的自动记账。
